import { Injectable, NgZone } from '@angular/core';
import { interval, ReplaySubject } from 'rxjs';
import { tap } from 'rxjs/operators';
import { GoogleAuth2LoaderService } from './google-auth2-loader.service';
import { GoogleApiLoaderService } from './google-api-loader.service';
import * as i0 from "@angular/core";
import * as i1 from "./google-auth2-loader.service";
import * as i2 from "./google-api-loader.service";
export class GoogleAuthService {
    constructor(googleAuth2LoaderService, googleApiLoaderService, ngZone) {
        this.googleAuth2LoaderService = googleAuth2LoaderService;
        this.googleApiLoaderService = googleApiLoaderService;
        this.ngZone = ngZone;
        this._authState = new ReplaySubject(1);
        this._loginState = new ReplaySubject(1);
        this.SIGN_IN_EXPIRE_KEY = 'loginExpirationDate';
        if (this.googleApiLoaderService.isMocked()) {
            this.signIn();
        }
        else {
            this.googleApiLoaderService.onLoad().subscribe(() => {
                this.googleAuth2LoaderService.getAuth().subscribe(auth => this.authLoaded(auth), () => this.removeState());
                interval(20 * 60 * 1000).pipe(// run every 20min
                tap(() => this.refreshToken())).subscribe();
            });
        }
    }
    get authState() {
        return this._authState.asObservable();
    }
    get loginState() {
        return this._loginState.asObservable();
    }
    signIn() {
        if (this.googleApiLoaderService.isMocked()) {
            this._loginState.next(JSON.parse(localStorage.getItem('user')));
            this._authState.next(JSON.parse(localStorage.getItem('user')));
        }
        else {
            const now = new Date();
            const expirationDate = this.setTime(now, null, now.getMinutes() + 5);
            localStorage.setItem(this.SIGN_IN_EXPIRE_KEY, expirationDate.toISOString());
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            this.auth.signIn({
                prompt: 'select_account',
                ux_mode: isSafari ? 'popup' : 'redirect',
            }).then(() => this.fetchLoginData());
        }
    }
    signOut() {
        if (!this.googleApiLoaderService.isMocked()) {
            this.auth.signOut();
        }
        this.removeState();
    }
    fetchLoginData() {
        return this.auth.currentUser.get().reloadAuthResponse().then(r => {
            this.ngZone.run(() => {
                this._loginState.next(this.getProfile(r.id_token, r.expires_at));
                this._authState.next(this.getProfile(r.id_token, r.expires_at));
            });
        });
    }
    refreshToken() {
        return this.auth.currentUser.get().reloadAuthResponse().then(r => {
            this.ngZone.run(() => this._authState.next(this.getProfile(r.id_token, r.expires_at)));
        });
    }
    authLoaded(auth) {
        this.auth = auth;
        if (this.auth.currentUser.get().isSignedIn()) {
            this.fetchLoginData();
            localStorage.removeItem(this.SIGN_IN_EXPIRE_KEY);
        }
        else {
            const signInDateExpireDate = new Date(localStorage.getItem(this.SIGN_IN_EXPIRE_KEY));
            if (signInDateExpireDate > new Date()) {
                this._loginState.next({ type: 'cookiesNotEnabled' });
                this._authState.next(null);
            }
            else {
                this.removeState();
            }
        }
    }
    removeState() {
        this._authState.next(null);
        this._loginState.next(null);
    }
    getProfile(token, expiresAt) {
        const p = this.auth.currentUser.get().getBasicProfile();
        return p ? {
            id: p.getId(),
            email: p.getEmail(),
            firstName: p.getGivenName(),
            lastName: p.getFamilyName(),
            avatar: p.getImageUrl(),
            idToken: token,
            tokenExpiresAt: expiresAt,
        } : null;
    }
    setTime(date, hours, minutes, seconds, milliseconds) {
        const newDate = new Date(date);
        if (typeof hours === 'number') {
            newDate.setHours(hours);
        }
        if (typeof minutes === 'number') {
            newDate.setMinutes(minutes);
        }
        if (typeof seconds === 'number') {
            newDate.setSeconds(seconds);
        }
        if (typeof milliseconds === 'number') {
            newDate.setMilliseconds(milliseconds);
        }
        return newDate;
    }
}
/** @nocollapse */ GoogleAuthService.ɵfac = function GoogleAuthService_Factory(t) { return new (t || GoogleAuthService)(i0.ɵɵinject(i1.GoogleAuth2LoaderService), i0.ɵɵinject(i2.GoogleApiLoaderService), i0.ɵɵinject(i0.NgZone)); };
/** @nocollapse */ GoogleAuthService.ɵprov = i0.ɵɵdefineInjectable({ token: GoogleAuthService, factory: GoogleAuthService.ɵfac });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(GoogleAuthService, [{
        type: Injectable
    }], function () { return [{ type: i1.GoogleAuth2LoaderService }, { type: i2.GoogleApiLoaderService }, { type: i0.NgZone }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWF1dGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvc2VydmljZXMvZ29vZ2xlLWF1dGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsUUFBUSxFQUFjLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHckMsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDekUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7Ozs7QUFJckUsTUFBTSxPQUFPLGlCQUFpQjtJQWU1QixZQUNVLHdCQUFrRCxFQUNsRCxzQkFBOEMsRUFDOUMsTUFBYztRQUZkLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUM5QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBakJoQixlQUFVLEdBQTRCLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNELGdCQUFXLEdBQTBDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBR2pFLHVCQUFrQixHQUFHLHFCQUFxQixDQUFDO1FBZTFELElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQzFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNmO2FBQU07WUFDTCxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDbEQsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FDL0MsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENB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akIsaUJBQWlCLFdBQWpCLGlCQUFpQjt1RkFBakIsaUJBQWlCO2NBRDdCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGludGVydmFsLCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cblxuaW1wb3J0IHsgR29vZ2xlQXV0aDJMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9nb29nbGUtYXV0aDItbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgR29vZ2xlQXBpTG9hZGVyU2VydmljZSB9IGZyb20gJy4vZ29vZ2xlLWFwaS1sb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBBdXRoRGF0YSwgU2lnbkluRXJyb3IgfSBmcm9tICcuLi9tb2RlbHMvYXV0aCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBHb29nbGVBdXRoU2VydmljZSB7XG4gIHByaXZhdGUgX2F1dGhTdGF0ZTogUmVwbGF5U3ViamVjdDxBdXRoRGF0YT4gPSBuZXcgUmVwbGF5U3ViamVjdCgxKTtcbiAgcHJpdmF0ZSBfbG9naW5TdGF0ZTogUmVwbGF5U3ViamVjdDxBdXRoRGF0YSB8IFNpZ25JbkVycm9yPiA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuICBwcml2YXRlIGF1dGg6IGdhcGkuYXV0aDIuR29vZ2xlQXV0aDtcblxuICBwcml2YXRlIHJlYWRvbmx5IFNJR05fSU5fRVhQSVJFX0tFWSA9ICdsb2dpbkV4cGlyYXRpb25EYXRlJztcblxuICBnZXQgYXV0aFN0YXRlKCk6IE9ic2VydmFibGU8QXV0aERhdGE+IHtcbiAgICByZXR1cm4gdGhpcy5fYXV0aFN0YXRlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZ2V0IGxvZ2luU3RhdGUoKTogT2JzZXJ2YWJsZTxBdXRoRGF0YSB8IFNpZ25JbkVycm9yPiB7XG4gICAgcmV0dXJuIHRoaXMuX2xvZ2luU3RhdGUuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGdvb2dsZUF1dGgyTG9hZGVyU2VydmljZTogR29vZ2xlQXV0aDJMb2FkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgZ29vZ2xlQXBpTG9hZGVyU2VydmljZTogR29vZ2xlQXBpTG9hZGVyU2VydmljZSxcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lXG4gICkge1xuICAgIGlmICh0aGlzLmdvb2dsZUFwaUxvYWRlclNlcnZpY2UuaXNNb2NrZWQoKSkge1xuICAgICAgdGhpcy5zaWduSW4oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5nb29nbGVBcGlMb2FkZXJTZXJ2aWNlLm9uTG9hZCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuZ29vZ2xlQXV0aDJMb2FkZXJTZXJ2aWNlLmdldEF1dGgoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgYXV0aCA9PiB0aGlzLmF1dGhMb2FkZWQoYXV0aCksXG4gICAgICAgICAgKCkgPT4gdGhpcy5yZW1vdmVTdGF0ZSgpXG4gICAgICAgICk7XG4gICAgICAgIGludGVydmFsKDIwICogNjAgKiAxMDAwKS5waXBlKCAgLy8gcnVuIGV2ZXJ5IDIwbWluXG4gICAgICAgICAgdGFwKCgpID0+IHRoaXMucmVmcmVzaFRva2VuKCkpXG4gICAgICAgICkuc3Vic2NyaWJlKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2lnbkluKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmdvb2dsZUFwaUxvYWRlclNlcnZpY2UuaXNNb2NrZWQoKSkge1xuICAgICAgdGhpcy5fbG9naW5TdGF0ZS5uZXh0KEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXInKSkpO1xuICAgICAgdGhpcy5fYXV0aFN0YXRlLm5leHQoSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25zdCBleHBpcmF0aW9uRGF0ZSA9IHRoaXMuc2V0VGltZShub3csIG51bGwsIG5vdy5nZXRNaW51dGVzKCkgKyA1KTtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuU0lHTl9JTl9FWFBJUkVfS0VZLCBleHBpcmF0aW9uRGF0ZS50b0lTT1N0cmluZygpKTtcbiAgICAgIGNvbnN0IGlzU2FmYXJpID0gL14oKD8hY2hyb21lfGFuZHJvaWQpLikqc2FmYXJpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTtcbiAgICAgIHRoaXMuYXV0aC5zaWduSW4oe1xuICAgICAgICBwcm9tcHQ6ICdzZWxlY3RfYWNjb3VudCcsXG4gICAgICAgIHV4X21vZGU6IGlzU2FmYXJpID8gJ3BvcHVwJyA6ICdyZWRpcmVjdCcsXG4gICAgICB9KS50aGVuKCgpID0+IHRoaXMuZmV0Y2hMb2dpbkRhdGEoKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNpZ25PdXQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmdvb2dsZUFwaUxvYWRlclNlcnZpY2UuaXNNb2NrZWQoKSkge1xuICAgICAgdGhpcy5hdXRoLnNpZ25PdXQoKTtcbiAgICB9XG4gICAgdGhpcy5yZW1vdmVTdGF0ZSgpO1xuICB9XG5cbiAgcHVibGljIGZldGNoTG9naW5EYXRhKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmF1dGguY3VycmVudFVzZXIuZ2V0KCkucmVsb2FkQXV0aFJlc3BvbnNlKCkudGhlbihyID0+IHtcbiAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgIHRoaXMuX2xvZ2luU3RhdGUubmV4dCh0aGlzLmdldFByb2ZpbGUoci5pZF90b2tlbiwgci5leHBpcmVzX2F0KSk7XG4gICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KHRoaXMuZ2V0UHJvZmlsZShyLmlkX3Rva2VuLCByLmV4cGlyZXNfYXQpKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlZnJlc2hUb2tlbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5hdXRoLmN1cnJlbnRVc2VyLmdldCgpLnJlbG9hZEF1dGhSZXNwb25zZSgpLnRoZW4ociA9PiB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5fYXV0aFN0YXRlLm5leHQodGhpcy5nZXRQcm9maWxlKHIuaWRfdG9rZW4sIHIuZXhwaXJlc19hdCkpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXV0aExvYWRlZChhdXRoOiBnYXBpLmF1dGgyLkdvb2dsZUF1dGgpOiB2b2lkIHtcbiAgICB0aGlzLmF1dGggPSBhdXRoO1xuICAgIGlmICh0aGlzLmF1dGguY3VycmVudFVzZXIuZ2V0KCkuaXNTaWduZWRJbigpKSB7XG4gICAgICB0aGlzLmZldGNoTG9naW5EYXRhKCk7XG4gICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLlNJR05fSU5fRVhQSVJFX0tFWSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNpZ25JbkRhdGVFeHBpcmVEYXRlID0gbmV3IERhdGUobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5TSUdOX0lOX0VYUElSRV9LRVkpKTtcbiAgICAgIGlmIChzaWduSW5EYXRlRXhwaXJlRGF0ZSA+IG5ldyBEYXRlKCkpIHtcbiAgICAgICAgdGhpcy5fbG9naW5TdGF0ZS5uZXh0KHsgdHlwZTogJ2Nvb2tpZXNOb3RFbmFibGVkJyB9KTtcbiAgICAgICAgdGhpcy5fYXV0aFN0YXRlLm5leHQobnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbW92ZVN0YXRlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVTdGF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9hdXRoU3RhdGUubmV4dChudWxsKTtcbiAgICB0aGlzLl9sb2dpblN0YXRlLm5leHQobnVsbCk7XG4gIH1cblxuICBwcml2YXRlIGdldFByb2ZpbGUodG9rZW46IHN0cmluZywgZXhwaXJlc0F0OiBudW1iZXIpOiBBdXRoRGF0YSB7XG4gICAgY29uc3QgcCA9IHRoaXMuYXV0aC5jdXJyZW50VXNlci5nZXQoKS5nZXRCYXNpY1Byb2ZpbGUoKTtcbiAgICByZXR1cm4gcCA/IHtcbiAgICAgIGlkOiBwLmdldElkKCksXG4gICAgICBlbWFpbDogcC5nZXRFbWFpbCgpLFxuICAgICAgZmlyc3ROYW1lOiBwLmdldEdpdmVuTmFtZSgpLFxuICAgICAgbGFzdE5hbWU6IHAuZ2V0RmFtaWx5TmFtZSgpLFxuICAgICAgYXZhdGFyOiBwLmdldEltYWdlVXJsKCksXG4gICAgICBpZFRva2VuOiB0b2tlbixcbiAgICAgIHRva2VuRXhwaXJlc0F0OiBleHBpcmVzQXQsXG4gICAgfSA6IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHNldFRpbWUoZGF0ZTogc3RyaW5nIHwgRGF0ZSwgaG91cnM/OiBudW1iZXIsIG1pbnV0ZXM/OiBudW1iZXIsIHNlY29uZHM/OiBudW1iZXIsIG1pbGxpc2Vjb25kcz86IG51bWJlcik6IERhdGUge1xuICAgIGNvbnN0IG5ld0RhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICBpZiAodHlwZW9mIGhvdXJzID09PSAnbnVtYmVyJykge1xuICAgICAgbmV3RGF0ZS5zZXRIb3Vycyhob3Vycyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbWludXRlcyA9PT0gJ251bWJlcicpIHtcbiAgICAgIG5ld0RhdGUuc2V0TWludXRlcyhtaW51dGVzKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBzZWNvbmRzID09PSAnbnVtYmVyJykge1xuICAgICAgbmV3RGF0ZS5zZXRTZWNvbmRzKHNlY29uZHMpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG1pbGxpc2Vjb25kcyA9PT0gJ251bWJlcicpIHtcbiAgICAgIG5ld0RhdGUuc2V0TWlsbGlzZWNvbmRzKG1pbGxpc2Vjb25kcyk7XG4gICAgfVxuICAgIHJldHVybiBuZXdEYXRlO1xuICB9XG59XG4iXX0=